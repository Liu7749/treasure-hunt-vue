<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vue å¯»å®å†’é™©æ¸¸æˆ - å¸¦èƒŒæ™¯éŸ³ä¹</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .screen { min-height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .btn {
      padding: 12px 24px; margin: 8px; border: none; border-radius: 50px; font-size: 16px; cursor: pointer;
      transition: all 0.3s; font-weight: bold;
    }
    .btn-primary { background: #4f46e5; color: white; }
    .btn-primary:hover { background: #4338ca; transform: scale(1.05); }
    .btn-secondary { background: #64748b; color: white; }
    .card {
      background: white; border-radius: 20px; padding: 30px; margin: 20px; width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    .locations-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; width: 100%;
    }
    .location-item {
      background: #f8fafc; padding: 20px; border-radius: 16px; cursor: pointer;
      transition: all 0.3s; border: 2px solid transparent;
    }
    .location-item:hover { transform: translateY(-5px); border-color: #4f46e5; }
    .progress-log {
      background: #f1f5f9; padding: 20px; border-radius: 12px; min-height: 150px;
      display: flex; flex-direction: column; justify-content: center;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; }
    th { background: #f8fafc; }
    .treasure-found { color: gold; font-size: 1.2em; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
  </style>
</head>
<body>
  <!-- éŸ³é¢‘å…ƒç´ ï¼ˆå¿…é¡»æ”¾åœ¨ #app å¤–éƒ¨ï¼Œç¡®ä¿èƒ½è¢« JS è·å–ï¼‰ -->
  <audio id="bg-audio" preload="auto" loop>
    <source src="assets/audio/background.mp3" type="audio/mpeg">
  </audio>
  <audio id="library-audio" preload="auto" loop>
    <source src="assets/audio/library.mp3" type="audio/mpeg">
  </audio>
  <audio id="temple-audio" preload="auto" loop>
    <source src="assets/audio/temple.mp3" type="audio/mpeg">
  </audio>
  <audio id="forest-audio" preload="auto" loop>
    <source src="assets/audio/forest.mp3" type="audio/mpeg">
  </audio>
  <audio id="cave-audio" preload="auto" loop>
    <source src="assets/audio/cave.mp3" type="audio/mpeg">
  </audio>

  <div id="app">
    <!-- ç™»å½•é¡µ -->
    <div v-if="!currentUser" class="screen">
      <div class="card">
        <h1 style="font-size: 2.5em; margin-bottom: 20px;">ğŸ—ºï¸ å¯»å®å†’é™©</h1>
        <p style="margin-bottom: 20px;">è¯·è¾“å…¥ä½ çš„å†’é™©è€…åå­—</p>
        <input
          v-model="username"
          @keyup.enter="login"
          placeholder="ä¾‹å¦‚ï¼šå‹‡æ•¢çš„åˆ˜ç•™"
          style="padding: 12px; width: 80%; max-width: 300px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;"
        />
        <button @click="login" class="btn btn-primary">å¼€å§‹å†’é™©</button>
      </div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div v-else class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
        <h1 style="color: white; font-size: 2em;">å¯»å®å†’é™©</h1>
        <div>
          <button @click="showLeaderboard = !showLeaderboard" class="btn btn-primary">
            {{ showLeaderboard ? 'ğŸ® è¿”å›æ¸¸æˆ' : 'ğŸ† æ’è¡Œæ¦œ' }}
          </button>
          <button @click="logout" class="btn btn-secondary">é€€å‡º ({{ currentUser.username }})</button>
        </div>
      </div>

      <!-- æ’è¡Œæ¦œ -->
      <div v-if="showLeaderboard" class="card">
        <h2>ğŸ† å†’é™©è€…æ’è¡Œæ¦œ</h2>
        <table v-if="rankedUsers.length > 0">
          <thead>
            <tr>
              <th>æ’å</th>
              <th>å†’é™©è€…</th>
              <th>å®è—æ•°</th>
              <th>æ¸¸æˆæ¬¡æ•°</th>
              <th>æœ€ä½³æ—¶é—´(s)</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(user, index) in rankedUsers" :key="user.username">
              <td>#{{ index + 1 }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.treasures }}</td>
              <td>{{ user.games }}</td>
              <td>{{ user.bestTime ? user.bestTime.toFixed(1) : 'â€”' }}</td>
            </tr>
          </tbody>
        </table>
        <p v-else>æš‚æ— æ•°æ®ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªä¸Šæ¦œè€…ï¼</p>
      </div>

      <!-- æ¸¸æˆä¸»ç•Œé¢ -->
      <div v-else>
        <!-- å…¨æ™¯åœ°å›¾ -->
        <div v-if="currentView === 'map'" class="card">
          <h2>é€‰æ‹©ä½ çš„å†’é™©åœ°ç‚¹</h2>
          <div class="locations-grid">
            <div v-for="(loc, key) in locations" :key="key" @click="selectLocation(key)" class="location-item">
              <div style="font-size: 2em; margin-bottom: 10px;">{{ loc.icon }}</div>
              <div>{{ loc.name }}</div>
            </div>
          </div>
        </div>

        <!-- å†’é™©è¿‡ç¨‹ -->
        <div v-else-if="currentView === 'adventure'" class="card">
          <button @click="goBackToMap" class="btn btn-secondary">â¬…ï¸ è¿”å›åœ°å›¾</button>
          <h2 style="margin: 20px 0;">{{ currentLocation?.name }}</h2>
          <div class="progress-log">
            <div v-for="(msg, i) in progress" :key="i" :class="{ 'treasure-found': msg.includes('æ­å–œ') }">
              {{ msg }}
            </div>
            <div v-if="progress.length === 0">ç‚¹å‡»â€œå¼€å§‹å†’é™©â€æŒ‰é’®å¯åŠ¨å¯»å®ï¼</div>
          </div>
          <button
            @click="startAdventure"
            :disabled="isPlaying"
            :class="isPlaying ? 'btn-secondary' : 'btn-primary'"
            class="btn"
            style="margin-top: 20px;"
          >
            {{ isPlaying ? 'ğŸ” å†’é™©ä¸­...' : 'ğŸš€ å¼€å§‹å¯»å®' }}
          </button>
        </div>
      </div>
    </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    // ====== æ¨¡æ‹Ÿå¼‚æ­¥å¯»å® API ======
    const TreasureAPI = {
      async getInitialClue(location) {
        await new Promise(r => setTimeout(r, 1000));
        const clues = {
          library: "åœ¨å¤è€çš„å›¾ä¹¦é¦†é‡Œæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçº¿ç´¢ï¼šä¸€æœ¬ç¥ç§˜çš„å¤ç±ä¸­å¤¹ç€ä¸€å¼ æ³›é»„çš„ç¾Šçš®çº¸...",
          temple: "åœ¨ç¥ç§˜ç¥åº™çš„ç¥­å›ä¸Šå‘ç°äº†ä¸€ä¸ªå¤è€çš„å·è½´ï¼Œä¸Šé¢å†™ç€ç¥ç§˜çš„ç¬¦æ–‡...",
          forest: "åœ¨å¹½æš—æ£®æ—çš„å¤è€æ©¡æ ‘ä¸‹ï¼Œå‘ç°äº†ä¸€ä¸ªåˆ»æœ‰ç¥ç§˜ç¬¦å·çš„çŸ³ç¢‘...",
          cave: "åœ¨ç¥ç§˜æ´ç©´çš„æ·±å¤„ï¼Œå²©å£ä¸Šé—ªçƒç€å¥‡å¼‚çš„å…‰èŠ’ï¼Œä¼¼ä¹éšè—ç€ä»€ä¹ˆ..."
        };
        return clues[location];
      },
      async decodeScript(clue) {
        await new Promise(r => setTimeout(r, 1500));
        return "è§£ç æˆåŠŸï¼çº¿ç´¢æŒ‡å‘äº†ä¸€ä¸ªéšè—çš„å®ç®±ä½ç½®...";
      },
      async searchLocation(location) {
        await new Promise(r => setTimeout(r, 2000));
        if (Math.random() < 0.3) throw new Error("ç³Ÿç³•ï¼é‡åˆ°äº†å®ˆæŠ¤è€…ï¼");
        const finds = {
          library: "åœ¨å›¾ä¹¦é¦†çš„å¯†å®¤ä¸­æ‰¾åˆ°äº†ä¸€ä¸ªå¤è€çš„æœ¨ç®±...",
          temple: "åœ¨ç¥åº™çš„ç¥­å›ä¸‹æ–¹å‘ç°äº†ä¸€ä¸ªçŸ³åˆ¶å®ç®±...",
          forest: "åœ¨æ£®æ—æ·±å¤„çš„æ ‘æ´é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªç²¾è‡´çš„é“ç›’...",
          cave: "åœ¨æ´ç©´çš„æš—å®¤ä¸­å‘ç°äº†ä¸€ä¸ªé—ªè€€çš„æ°´æ™¶ç®±..."
        };
        return finds[location];
      },
      async openTreasureBox() {
        await new Promise(r => setTimeout(r, 1000));
        return "ğŸ‰ æ­å–œï¼ä½ æ‰¾åˆ°äº†ä¼ è¯´ä¸­çš„å®è—ï¼";
      }
    };

    // ====== ä¸»åº”ç”¨ ======
    const App = {
      setup() {
        // éŸ³é¢‘æ§åˆ¶
        const audioElements = {
          background: document.getElementById('bg-audio'),
          library: document.getElementById('library-audio'),
          temple: document.getElementById('temple-audio'),
          forest: document.getElementById('forest-audio'),
          cave: document.getElementById('cave-audio')
        };

        // è®¾ç½®éŸ³é‡
        Object.values(audioElements).forEach(audio => {
          if (audio) audio.volume = 0.3;
        });

        const playMusic = (type) => {
          // æš‚åœæ‰€æœ‰éŸ³é¢‘
          Object.values(audioElements).forEach(audio => {
            if (audio && !audio.paused) {
              audio.pause();
              audio.currentTime = 0;
            }
          });
          // æ’­æ”¾æŒ‡å®šéŸ³é¢‘
          const audio = audioElements[type];
          if (audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾éœ€ç”¨æˆ·äº¤äº’"));
          }
        };

        // ç”¨æˆ·çŠ¶æ€
        const username = ref('');
        const currentUser = ref(null);
        const users = ref([]);

        // æ¸¸æˆçŠ¶æ€
        const currentView = ref('map');
        const showLeaderboard = ref(false);
        const selectedLocationKey = ref(null);
        const progress = ref([]);
        const isPlaying = ref(false);

        const locations = {
          library: { name: 'å¤è€å›¾ä¹¦é¦†', icon: 'ğŸ›ï¸' },
          temple: { name: 'ç¥ç§˜ç¥åº™', icon: 'â›©ï¸' },
          forest: { name: 'å¹½æš—æ£®æ—', icon: 'ğŸŒ³' },
          cave: { name: 'ç¥ç§˜æ´ç©´', icon: 'ğŸ•³ï¸' }
        };

        const currentLocation = computed(() => 
          selectedLocationKey.value ? locations[selectedLocationKey.value] : null
        );

        const rankedUsers = computed(() => {
          return [...users.value]
            .sort((a, b) => 
              b.treasures - a.treasures || 
              (a.bestTime || Infinity) - (b.bestTime || Infinity)
            )
            .slice(0, 10);
        });

        // å­˜å‚¨ç®¡ç†
        const loadStorage = () => {
          const savedUsers = localStorage.getItem('treasure_users');
          const savedCurrent = localStorage.getItem('current_user');
          if (savedUsers) users.value = JSON.parse(savedUsers);
          if (savedCurrent) currentUser.value = JSON.parse(savedCurrent);
        };

        const saveStorage = () => {
          localStorage.setItem('treasure_users', JSON.stringify(users.value));
          localStorage.setItem('current_user', JSON.stringify(currentUser.value));
        };

        // ç”¨æˆ·æ“ä½œ
        const login = () => {
          if (!username.value.trim()) return;
          let user = users.value.find(u => u.username === username.value);
          if (!user) {
            user = { username: username.value, games: 0, treasures: 0, bestTime: null };
            users.value.push(user);
          }
          currentUser.value = user;
          saveStorage();
          playMusic('background'); // ç™»å½•åæ’­æ”¾èƒŒæ™¯éŸ³ä¹
          username.value = '';
        };

        const logout = () => {
          currentUser.value = null;
          // åœæ­¢æ‰€æœ‰éŸ³ä¹
          Object.values(audioElements).forEach(audio => {
            if (audio && !audio.paused) audio.pause();
          });
          saveStorage();
        };

        const updateStats = (treasureFound, timeSec) => {
          const user = users.value.find(u => u.username === currentUser.value.username);
          user.games += 1;
          if (treasureFound) user.treasures += 1;
          if (treasureFound) {
            user.bestTime = user.bestTime ? Math.min(user.bestTime, timeSec) : timeSec;
          }
          currentUser.value = { ...user };
          saveStorage();
        };

        // æ¸¸æˆé€»è¾‘
        const selectLocation = (key) => {
          selectedLocationKey.value = key;
          currentView.value = 'adventure';
          progress.value = [];
          playMusic(key); // æ’­æ”¾å¯¹åº”åœºæ™¯éŸ³ä¹
        };

        const goBackToMap = () => {
          currentView.value = 'map';
          playMusic('background'); // è¿”å›æ—¶æ’­æ”¾èƒŒæ™¯éŸ³ä¹
        };

        const startAdventure = async () => {
          if (isPlaying.value || !selectedLocationKey.value) return;
          isPlaying.value = true;
          progress.value = [];
          const startTime = Date.now();

          try {
            const clue = await TreasureAPI.getInitialClue(selectedLocationKey.value);
            progress.value.push(clue);

            const decoded = await TreasureAPI.decodeScript(clue);
            progress.value.push(decoded);

            const found = await TreasureAPI.searchLocation(selectedLocationKey.value);
            progress.value.push(found);

            const treasure = await TreasureAPI.openTreasureBox();
            progress.value.push(treasure);

            const timeSec = (Date.now() - startTime) / 1000;
            updateStats(true, timeSec);
          } catch (err) {
            progress.value.push(`âŒ ä»»åŠ¡å¤±è´¥: ${err.message}`);
            const timeSec = (Date.now() - startTime) / 1000;
            updateStats(false, timeSec);
          } finally {
            isPlaying.value = false;
          }
        };

        onMounted(() => {
          loadStorage();
          // å¦‚æœå·²ç™»å½•ï¼Œæ’­æ”¾èƒŒæ™¯éŸ³ä¹
          if (currentUser.value) {
            playMusic('background');
          }
        });

        return {
          username,
          currentUser,
          users,
          login,
          logout,
          rankedUsers,
          currentView,
          showLeaderboard,
          selectedLocationKey,
          progress,
          isPlaying,
          locations,
          currentLocation,
          selectLocation,
          goBackToMap,
          startAdventure
        };
      }
    };

    createApp(App).mount('#app');
  </script>
</body>
</html>